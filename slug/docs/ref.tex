\documentclass{article}
\usepackage{times}
\usepackage{natbib}
\usepackage{url}
\usepackage{textcomp}
\bibpunct{(}{)}{;}{a}{,}{,}
\begin{document}
\title{Student Robotics Programming Reference}
\date{\today}
\maketitle
\begin{abstract}
This document details the programming interface for Student Robotics
robots.  For more information on programming in Python and about how
to bring all this together see the tutorial. 
\end{abstract}
\section{Directory structure}
The robot source code must be in a zip file named \texttt{robot.zip}.
This zip file must act as a Python module, and so it must contain a
file named \texttt{\_\_init\_\_.py}.  The zip file must contain a
second file named \texttt{robot.py}.  Other \texttt{.py} files can be 
included to improve code organisation.  The checkout function of the
RoboIDE system creates zip files in this format. 

\subsection{\_\_init\_\_.py}
This file is used so Python can identify the zip file as a compressed module.
It should be empty.
\subsection{robot.py}
This file must at least contain the main function for the robot control
algorithm.
\subsection{File structure}
\subsubsection{Imports}
All files containing parts of the robot control algorithm must import the Student
Robotics interface components with: \texttt{from sr import *}.  Other standard
Python modules can be imported as required.
\section{Main function}
In \texttt{robot.py} there must be a function with the form:

\begin{verbatim}
def main(corner, colour, game):
\end{verbatim}

When the robot is started, this function will be called.
\begin{description}
\item[corner]This is a number from 0 to 3 that identifies the corner the robot
starts in.  The number is the colour number of that corner.
\item[colour]The colour of the tokens that the robot is looking for.
\item[game]The game being played. 0 for collect any token, 1 for collecting
only tokens of a specific colour.
\end{description}
\section{Yielding control and interrupts}
Once the main function is called, the algorithm has control of the robot.  The
algorithm must \texttt{yield} control of the robot once it has
processed any incoming data, and configured any outputs accordingly.
The \texttt{yield} command passes control of the robot over to the
Student Robotics environment. When an event occurs, the environment will pass
control back to the algorithm at the instruction after the \texttt{yield}
statement.  When control is passed back to the
algorithm the \texttt{event} variable has been set to contain information
about the event that just occurred.

\subsection{Using \texttt{yield}}
\subsubsection{Timeouts}
The \texttt{yield} statement can be used to wait for a set amount of
time.  For example:

\begin{verbatim}
yield 4
\end{verbatim}

Causes the program to be delayed for 4 seconds.

\subsubsection{Waiting on events}
The \texttt{yield} statement can be used to wait for an event to
occur.  For example:

\begin{verbatim}
yield io
\end{verbatim}

Causes the algorithm to wait until a dio (digital IO) event is received.

\subsubsection{Combinations of events and timeout}
The \texttt{yield} statement can be used to wait on a combination of events and
a timeout, whichever occurs first:

\begin{verbatim}
yield io, 5
\end{verbatim}

Causes the algorithm to wait until a dio event is received or 5 seconds,
whichever comes first.

\subsubsection{Calling subroutines}
Control of the robot can be passed to subroutines, allowing the program to be
split up into easier to understand parts.  The \texttt{yield} statement can be
used to pass control of the robot to a subroutine.  When the subroutine returns,
the program continues from the yield statement.  If more information is
passed to yield after the name of a subroutine, then that information is passed
as argument(s) to that subroutine.  For example:

\begin{verbatim}
yield findTokens, 3
\end{verbatim}

Causes control of the robot to be passed to the findTokens subroutine with the
argument 3.

\subsection{The \texttt{event} variable}
The \texttt{event} variable is set when control is returned after a
yield. It contains information regarding the event that caused control
to be passed back.

\subsubsection{Finding the event source}
The \texttt{event} variable will return true when compared to the
event source that led to its creation:

\begin{verbatim}
yield io, 5 #Wait until a dio event or 5 seconds passes

if event == io:
    pass #A io event happened first (pass means do-nothing)
else:
    pass #A timeout is the only other option
\end{verbatim}

\subsection{IO Events}
IO events are caused by a change in the digital inputs of the
Joint IO board. After a io event causes a \texttt{yield} statement to
return control of the robot to the control algorithm, the
\texttt{event} variable will be set. The io inputs that have changed
are contained in a dictionary that can be accessed from \texttt{event.pins}: 

\begin{verbatim}
yield io, 5

if event == io:                #Is it an io event?
    if 0 in event.pins:        #Has input 0 been changed?
        if event.pins[0] == 1: #Is input 0 now a 1?
            pass
\end{verbatim}

\subsubsection{Monitoring specific pins}
Sometimes you will want to only wait for events on specific pins.  This can be
done by using \texttt{setsensitive} and \texttt{removesensitive} functions:

\begin{verbatim}

removesensitive(2) #Ignore pin 2 for now
yield io, 5

#Do stuff!

setsensitive(2) #Resume monitoring pin 2
\end{verbatim}

\subsection{Visual Events}
When the \texttt{vision} event source is passed to the \texttt{yield}
command, the robot will grab an image with its webcam and start to
process that image.  When this processing has finished, the vision
system will raise an event (whether a token is seen or not).  Any
tokens found are placed in the list \texttt{event.blobs}.  Each blob in this
list has a set of properties:  
\begin{description}
\item[colour] The colour of the blob
\item[mass] The number of pixels that make up the blob
\item[centrex] The number of pixels between the left of the image and
  the centre of the blob.
\item[centrey] The number of pixels down from the top of the image to the
  centre of the blob.
\end{description}

\begin{verbatim}
yield vision    #This will always return as soon as
                #a frame has been processed

for blob in event.blobs:    #Go through each blob in 
                            #turn. This does nothing if
                            #there are no blobs
    if blob.colour == 0:    #For each blob, check its colour
        pass
\end{verbatim}

\section{Controlling the robot}
\subsection{Controlling the motors}
The motor controller has two outputs.  The \texttt{setspeed} command
sets the direction of each motor and the power delivered to each one.

\begin{description}
\item[setspeed(n)] This sets both of the motors to n\% of maximum
power.  $-100<n<100$. Negative values of n drive the motors backwards.
\item[setspeed(n, m)] This sets the power delivered to motor 1 to n\%,
  and the power delivered to motor 2 to m\%. $-100<n,m<100$.
\end{description}

\subsection{Controlling the PWM board}
The Pulse Width Modulation board is used to control servo motors.  It is
controlled with the \texttt{setpos} function that takes two arguments:

\begin{verbatim}
setpos(n, m)
\end{verbatim}

This will set PWM board output $0<n<5$ to the position $0<m<100$.
\end{document}
